from ctypes import cast, POINTER
import pyaudio
import numpy as np
from comtypes import CLSCTX_ALL
from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume
CHUNK = 2**11
RATE = 44100
threshold = -12.902039527893066
devices = AudioUtilities.GetSpeakers()
interface = devices.Activate(IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
volume = cast(interface, POINTER(IAudioEndpointVolume))

# converter = [-65.25, -56.992191314697266, -51.671180725097656, -47.73759078979492, -44.61552047729492,
#             -42.026729583740234, -39.81534194946289, -37.88519287109375, -36.17274856567383, -34.63383865356445,
#             -33.23651123046875, -31.956890106201172,-30.77667808532715,-29.681535720825195, -28.66002082824707, 
#             -27.70285415649414, -26.80240821838379, -25.95233154296875, -25.147287368774414, -24.38274574279785,
#             -23.654823303222656, -22.960174560546875, -22.295886993408203, -21.6594181060791, -21.048532485961914,
#             -20.461252212524414, -19.895822525024414, -19.350669860839844, -18.824398040771484, -18.315736770629883,
#             -17.82354736328125, -17.3467960357666, -16.884546279907227, -16.435937881469727, -16.000192642211914, 
#             -15.576590538024902, -15.164472579956055, -14.763236045837402, -14.372318267822266, -13.991202354431152,
#             -13.61940860748291, -13.256492614746094, -12.902039527893066, -12.555663108825684, -12.217005729675293,
#             -11.88572883605957, -11.561516761779785, -11.2440767288208, -10.933131217956543, -10.62841796875,
#             -10.329694747924805, -10.036728858947754, -9.749302864074707, -9.46721076965332, -9.190258026123047,
#             -8.918261528015137, -8.651047706604004, -8.388449668884277, -8.130311965942383, -7.876484394073486,
#             -7.626824855804443, -7.381200790405273, -7.1394829750061035, -6.901548862457275,-6.6672821044921875,
#             -6.436570644378662, -6.209307670593262, -5.98539400100708, -5.764730453491211, -5.547224998474121,
#             -5.33278751373291, -5.121333599090576, -4.912779808044434, -4.707049369812012, -4.5040669441223145,
#             -4.3037590980529785, -4.1060566902160645, -3.9108924865722656, -3.718202590942383, -3.527923583984375,
#             -3.339998245239258, -3.1543679237365723, -2.970977306365967, -2.7897727489471436, -2.610703229904175,
#             -2.4337174892425537, -2.2587697505950928, -2.08581280708313, -1.9148017168045044, -1.7456932067871094,
#             -1.5784454345703125, -1.4130167961120605, -1.2493702173233032, -1.0874667167663574, -0.9272695183753967,
#             -0.768743097782135, -0.6118528842926025, -0.4565645754337311, -0.30284759402275085, -0.15066957473754883,
#             0.0]


def setVol(toggle):
    current = volume.GetMasterVolumeLevel()
    if toggle:
        if current < 0.00:
            volume.SetMasterVolumeLevel(-65.25, None)
    else:
        if current > 65.25:
            volume.SetMasterVolumeLevel(0.00, None)

def listener():
    p = pyaudio.PyAudio()
    stream = p.open(format=pyaudio.paInt16, channels=1, rate=RATE, input=True, frames_per_buffer=CHUNK)
    toggle=True # true is up false is down
    while True:
        data = np.frombuffer(stream.read(CHUNK), dtype=np.int16)
        peak = np.mean(np.abs(data))
        if peak < 50:
            volume.SetMasterVolumeLevel(-0.00, None)
        else:
            volume.SetMasterVolumeLevel(-65.25, None)

def main():
    listener()

if __name__ == "__main__":
    main()